# 坐标转换

---

* ### 坐标转换

  1. 默认情况下OpenGL ES中坐标系采用右手定则，坐标系方向如下图：  
     ![右手坐标系](/assets/OpenGL ES入门/三角形绘制/右手坐标系.png)
     * 沿着正y轴方向伸出你的右臂，手指着上方。
     * 大拇指指向右方。
     * 食指指向上方。
     * 中指向下弯曲90度。

  2. OpenGL ES中一共存在5种空间，每种空间对应一种坐标系。分别是：

     2.1 本地空间\(本地坐标系\)

     2.2 世界空间\(世界坐标系\)

     2.3 观察空间/视觉空间\(观察坐标系\)

     2.4 裁剪空间\(裁剪坐标系\)

     2.5 屏幕空间\(屏幕坐标系\)

     我们在创建物体时，所在空间为本地空间，最终绘制出来的结果在屏幕空间。这样我们就需要把物体坐标转换成最终的屏幕坐标。为了将坐标从一个空间转换到另一个空间，我们需要用到**3个变换矩阵\(模型矩阵、观察矩阵、投影矩阵\)**和一个**视口转换**。下图展示了整个变换过程：

     ![坐标系统转换过程](/assets/OpenGL ES入门/三角形绘制/坐标系统转换过程.png)

     ①物体坐标 × 模型矩阵 = 物体在世界坐标系中的坐标\(模型矩阵为单位矩阵时，物体坐标系和世界坐标系相同，可忽略。\)  
     模型矩阵设置：

     ```
     //设置sMMatrix为单位矩阵
     Matrix.setIdentityM(sMMatrix,0);
     ```

     ②物体在世界坐标系中的坐标 × 观察矩阵 = 物体在观察坐标系中的坐标  
     观察矩阵设置：见**摄像机(观察点)**  
     ③物体在观察坐标系中的坐标 × 投影矩阵 = 物体在裁剪坐标系中的坐标  
     投影矩阵设置：见**投影**  
     ④物体在裁剪坐标系中的坐标，通过视口转换，转换成最终屏幕坐标系中的坐标  
     视口转换设置：

     ```
     GLES20.glViewport(0, 0, width, height);
     ```

     注：OpenGL ES2.0及以上跟矩阵相关的操作都在`android.opengl.Matrix`中

* ### 摄像机(观察点)

  OpenGL ES本身没有摄像机概念，我们这里所说的摄像机是在观察空间中模拟出来的。  
  要定义一个摄像机(观察点)，需要**位置、方向、右向量、上向量**。
  ![摄像机定义](/assets/OpenGL ES基础/坐标转换/摄像机定义.png)
  ①摄像机位置：摄像机在世界坐标中的坐标点。
  ②摄像机方向：由上图可知我们只要知道目标位置，就可以计算出摄像机的方向(摄像机位置向量-目标位置向量)
  ③摄像机右向量：代表摄像机空间的x轴的正方向，我们已经计算出摄像机的方向，如果我们再知道摄像机的上向量，便可以计算出右向量(向量的叉乘)。
  
  这样我们只需要知道**摄像机位置、目标位置、摄像机上向量**就可以确定摄像机。
  Android中摄像机的设置如下：

   ```
   /**
    * sVMatrix 观察矩阵(OpenGL ES会根据设置参数生成观察矩阵，并赋值给mVMatrix)
    * 用于把世界空间坐标转换成观察空间坐标
    * 0 偏移量，从数组(mVMatrix)的第几个元素开发赋值。
    */
   Matrix.setLookAtM(sVMatrix,0,
                     0,0,3,//摄像机位置
                     0,0,0,//目标位置
                     0,1,0);//up向量
   ```
   注：摄像机的位置与目标位置可以决定屏幕坐标系为**右手坐标系**或**左手坐标系**。屏幕坐标系和OpenGL坐标系是两个不同的坐标系。
  
* ### 投影

  OpenGL ES 中分为两种投影，**正交投影**和**透视投影**，指定了裁剪空间的大小。

  1 **正交投影**：适合展示2D画面，没有现实物体效果\(近大远小\)。  
   近平面\(NEAE PLANE\)和远平面\(FAR PLANE\)中间的空间叫做**平截头体**

  ![正交投影](/assets/OpenGL ES入门/三角形绘制/正交投影.png)

  Android中正交投影的设置如下：

  ```
   /**
    * sProjMatrix    正交投影矩阵(OpenGL ES会根据设置参数生成正交投影矩阵，并赋值给mProjMatrix)
    *                用于把观察空间坐标转换成裁剪空间坐标。
    * 0              偏移量，从数组(sProjMatrix)的第几个元素开发赋值。
    * -r, r, -1 , 1  确定成像平面的大小。
    * 3, 5           z轴上近平面距离观察点的距离，z轴上远平面距离观察点的距离。
    */
   Matrix.orthoM(sProjMatrix, 0, 
                    -r, r, -1 , 1 ,
                    3, 5);
  ```

  3.2 **透视投影**：适合展示3D效果，模拟现实物体\(近大远小\)。

  ![透视投影](/assets/OpenGL ES入门/三角形绘制/透视投影.png)

  Android中透视投影的设置如下：

  ```
   /**
    * sProjMatrix 透视投影矩阵(OpenGL ES会根据设置参数生成透视投影矩阵，并赋值给sProjMatrix)
    * 0 偏移量
    * 45f 图中的fov，视角角度
    * r 宽高比
    * 3 近平面与摄像机的距离
    * 5 远平面与摄像机的距离
    */              
   Matrix.perspectiveM(sProjMatrix, 0,
                    45f, 
                    r, 
                    3, 5)

   /**
    * 此方法为设置平截头体，官方的解释为根据平截头体的6个面生成投影矩阵
    */
   Matrix.frustumM(mProjMatrix,0,
                    -r,r,-1,1,
                    3,5);
  ```
  注：成像平面的l、r、b、t决定屏幕的原点位置
  -r,r,-1,1,原点为屏幕的中心点。高=2*1，宽=2*r
  0, r, 1, 0,原点为屏幕的左上角。高=1，宽=r

