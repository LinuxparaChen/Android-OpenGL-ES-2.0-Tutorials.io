#三角形绘制

---

我们将初步使用GLSL着色器语言，了解OpenGL ES的开发流程。
Android中GLSurfaceView集成了集成了EGL，所以我们所有的展示都会在GLSurfaceView控件上。(EGL会在后面内容讲解)

1. **顶点着色器代码**
    ```
    //vec2 float类型的二维向量(长度为2的float类型数组)
    //vec3 float类型的三维向量(长度为3的float类型数组)
    //vec4 float类型的四维向量(长度为4的float类型数组)
    //三角形的顶点坐标
    attribute vec3 a_position;//attribute 属性修饰符 相当于局部变量，每次执行都需要重新赋值。
    //三角形的顶点颜色值(rgba)
    attribute vec4 a_color;
    //模型矩阵
    uniform mat4 u_MMatrix;//uniform 统一修饰符 相当于全局变量，除非重新赋值或更新，否则值不会改变。
    //观察矩阵
    uniform mat4 u_VMatrix;
    //投影矩阵
    uniform mat4 u_ProjMatrix;
    //传给片元着色器的颜色值
    varying vec4 v_color;//varying 顶点、片元着色器传值，变量名需要完全一致。
    
    void main() {
        //gl_Position 内部变量，OpenGLES会根据gl_Position的值(顶点)做图形绘制。
    	gl_Position = u_ProjMatrix * u_VMatrix * u_MMatrix * vec4(a_position,1.0);
    	v_color = a_color;
    }
    ```
1. **GLSurfaceView设置**
    ```
    //设置OpenGLES版本号
    mGLView.setEGLContextClientVersion(2);
    //设置渲染器
    mGLView.setRenderer(new TriangleRender());
    //设置渲染模式：
    //RENDERMODE_WHEN_DIRTY 被动渲染  调用requestRender()方法时才会绘制下一帧。
    //RENDERMODE_CONTINUOUSLY 主动渲染
    mGLView.setRenderMode(GLSurfaceView.RENDERMODE_CONTINUOUSLY);
    ```
2. **编写渲染器**
    
    TriangleRender需要实现GLSurfaceView.Renderer并实现三个方法：
    ```
    /**
     * 界面被创建时被调用
     * @param gl
     * @param config
     */
    @Override
    public void onSurfaceCreated(GL10 gl, EGLConfig config) {
        onCreate();
    }

    /**
     * 界面改变时被调用
     * @param gl
     * @param width
     * @param height
     */
    @Override
    public void onSurfaceChanged(GL10 gl, int width, int height) {
        onChange(width,height);
    }

    /**
     * 绘制一帧内容时被调用
     * @param gl
     */
    @Override
    public void onDrawFrame(GL10 gl) {
        onDraw();
    }
    ```
    2.1 **onCreate()方法**
    ```
    @Override
    public void onCreate() {
        //设置背景色，普通的setBackground()对GLSurfaceView无效
        GLES20.glClearColor(0.5f, 0.5f, 0.5f, 0.5f);
    }
    ```
    2.2 **onChange(int width, int height)方法**
    ```
    @Override
    public void onChange(int width, int height) {
        //设置视口
        GLES20.glViewport(0, 0, width, height);
        float radio = (float) width / height;
        //初始化变换矩阵为单位矩阵
        //sMMatrix：模型矩阵
        //0：偏移量
        Matrix.setIdentityM(sMMatrix, 0);
        //设置观察点(相机)矩阵，在坐标转换中详细介绍了每个参数的含义、及系统是怎么确定摄像机位置的。
        //sVMatrix：观察矩阵
        //0：偏移量
        Matrix.setLookAtM(sVMatrix, 0,
                0, 0, 3,//摄像机位置，
                0, 0, 0,//目标位置（摄像机和目标位置可以决定屏幕的坐标体系）
                0, 1, 0);//up向量(上向量)
        //设置正交投影矩阵
        //sProjMatrix：投影矩阵
        //0：偏移量
        Matrix.orthoM(sProjMatrix, 0,
                0, radio, 1, 0,//平截头体的四个坐标（可以确定坐标原点的位置，此时坐标原点为屏幕左上角）
                3, 10);//近平面距离摄像机的距离、远平面距离摄像机的距离
        mWidth = radio;
        mHeight = 1;
        //初始化顶点数据（顶点在局部空间中的位置）
        initVert();
        //初始化顶点颜色
        initVertColor();
        //加载着色器程序
        initShaderFromAsset(TRIANGLE_SHADER_TAG, "triangle/triangle.vert", "triangle/triangle.frag");
    }
    ```
    ```
    @Override
    public void initVert() {
        float[] verts = {
                mWidth / 2, 0.0f, 0.0f,//第一个顶点的xyz坐标
                0.0f, mHeight, 0.0f,//第二个顶点的xyz坐标
                mWidth, mHeight, 0.0f//第三个顶点的xyz坐标
        };
        //顶点个数
        mVertSize = verts.length / 3;
        mVertBuf = ShaderUtils.getFloatBuffer(verts);
    }
    ```
    ```
    @Override
    public void initVertColor() {
        float[] vertColor = {
                1.0f, 0.0f, 0.0f, 0.0f,//第一个顶点的rgba颜色值
                0.0f, 1.0f, 0.0f, 0.0f,//第二个顶点的rgba颜色值
                0.0f, 0.0f, 1.0f, 0.0f//第三个顶点的rgba颜色值
        };
        mVertColorBuf = ShaderUtils.getFloatBuffer(vertColor);
    }
    ```
    ```
    /**
     * 初始化着色器
     *
     * @param shaderTag
     * @param verFileName
     * @param fragFileName
     */
    protected void initShaderFromAsset(int shaderTag,String verFileName, String fragFileName) {
        //读取文件中的字符串(顶点着色器代码)
        String verCode = ShaderUtils.getCodeFromAsset(verFileName, getView().getResources());
        //读取文件中的字符串(片元着色器代码)
        String fragCode = ShaderUtils.getCodeFromAsset(fragFileName, getView().getResources());
        //着色器程序
        int shaderProgram = ShaderUtils.createProgram(verCode, fragCode);
        //查找着色器属性
        findShaderAttr(shaderTag,shaderProgram);
    }
    ```
    ```
    @Override
    protected void findShaderAttr(int shaderTag, int shaderProgram) {
        if (TRIANGLE_SHADER_TAG == shaderTag) {
            mTriangleShaderProgram = shaderProgram;
            //获取顶点着色器中a_position指针(attribute类型)
            a_position = GLES20.glGetAttribLocation(mTriangleShaderProgram, "a_position");
            //获取顶点着色器中a_color指针(attribute类型)
            a_color = GLES20.glGetAttribLocation(mTriangleShaderProgram, "a_color");
            //获取顶点着色器中u_MMatrix指针(uniform类型)
            u_mMatrix = GLES20.glGetUniformLocation(mTriangleShaderProgram, "u_MMatrix");
            //获取顶点着色器中u_VMatrix指针(uniform类型)
            u_vMatrix = GLES20.glGetUniformLocation(mTriangleShaderProgram, "u_VMatrix");
            //获取顶点着色器中u_ProjMatrix指针(uniform类型)
            u_projMatrix = GLES20.glGetUniformLocation(mTriangleShaderProgram, "u_ProjMatrix");
        }
    }
    ```